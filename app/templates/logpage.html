<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calorie Log - CalTrack</title>
  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Lucide Icons CDN -->
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'cal-blue': {
              light: '#90cdf4',
              DEFAULT: '#63b3ed',
              dark: '#4299e1',
            }
          }
        }
      }
    }
  </script>
  <style>
    html {
      scroll-behavior: smooth;
    }
    .nav-link {
      padding: 0.5rem 1rem;
      margin-left: 0.5rem;
      margin-right: 0.5rem;
      border-radius: 0.5rem;
      transition: all 300ms;
      color: #000000;
    }
    .nav-link:hover {
      background-color: #90cdf4;
      color: white;
    }
    .active {
      color: #63b3ed;
      font-weight: 600;
    }
    .brand-text {
      background-image: linear-gradient(to right, #63b3ed, #90cdf4);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    /* Back-to-top button styling */
    #backToTopBtn {
      display: block;
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 50px;
      height: 50px;
      background-color: #bfdbfe;
      color: white;
      text-align: center;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 1000;
      border: none;
      outline: none;
      cursor: pointer;
      padding: 10px;
      transition: background-color 0.3s, transform 0.3s;
    }
    #backToTopBtn:hover {
      background-color: #90cdf4;
      transform: translateY(-3px);
    }
    .btn {
      @apply bg-blue-100 hover:bg-blue-200 text-sm px-3 py-1 rounded shadow;
    }
    .btn-primary {
      @apply bg-cal-blue text-white px-4 py-2 rounded hover:bg-cal-blue-dark;
    }
    .btn-burn {
      @apply bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded shadow;
    }
    .card {
      @apply border p-4 rounded-lg shadow-sm bg-white;
    }
    /* Tab and carousel styles */
    .tab {
      transition: color 0.3s ease, border-color 0.3s ease;
    }
    .tab.active {
      color: #63b3ed;
      border-bottom: 2px solid #63b3ed;
    }
    .tab:hover {
      color: #4299e1;
    }
    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
    .hide-scrollbar {
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .carousel-item {
      flex: 0 0 auto;
      width: 280px;
      transition: transform 0.3s ease, box-shadow 0.3s ease;
      scroll-snap-align: start;
    }
    .carousel-item:hover {
      transform: translateY(-4px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }
    .carousel-nav {
      transition: background-color 0.3s ease, transform 0.3s ease;
    }
    .carousel-nav:hover {
      transform: scale(1.1);
    }
    .icon-sticker {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      transition: transform 0.3s ease;
    }
    .food-item .icon-sticker {
      background-color: #e0f2fe; /* cal-blue-light/10 */
    }
    .exercise-item .icon-sticker {
      background-color: #fee2e2; /* red-100 */
    }
    .carousel-item:hover .icon-sticker {
      transform: scale(1.1);
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
  <!-- Navigation Bar -->
  <nav class="bg-white shadow-md p-4 fixed top-0 left-0 right-0 z-10">
    <div class="container mx-auto flex justify-between items-center">
      <!-- Logo/Brand -->
      <a href="#" class="font-bold text-2xl flex items-center active">
        <i data-lucide="activity" class="w-6 h-6 mr-2 text-cal-blue"></i>
        <span class="brand-text">CalTrack</span>
      </a>
      <!-- Center Navigation -->
      <div class="hidden md:flex items-center space-x-1">
        <a href="#" class="nav-link flex items-center active">
          <i data-lucide="edit" class="w-4 h-4 mr-1"></i>
          Update
        </a>
        <a href="#" class="nav-link flex items-center">
          <i data-lucide="bar-chart" class="w-4 h-4 mr-1"></i>
          Visualisation
        </a>
        <a href="#" class="nav-link flex items-center">
          <i data-lucide="share-2" class="w-4 h-4 mr-1"></i>
          Sharing
        </a>
      </div>
      <!-- Right Navigation -->
      <div class="flex items-center">
        <a href="#" class="nav-link flex items-center">
          <i data-lucide="user" class="w-4 h-4 mr-1"></i>
          Profile
        </a>
      </div>
    </div>
  </nav>

  <div class="container mx-auto mt-24 px-24">
    <h1 class="text-3xl font-bold mb-6">Calorie Log</h1>

    <!-- Meal Selector -->
    <div class="mb-6">
      <label class="block font-semibold mb-1">Select Meal</label>
      <div class="flex flex-wrap gap-4">
        <label class="flex items-center gap-2">
          <input type="radio" name="meal_type" value="Breakfast" required> Breakfast
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="meal_type" value="Lunch"> Lunch
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="meal_type" value="Dinner"> Dinner
        </label>
        <label class="flex items-center gap-2">
          <input type="radio" name="meal_type" value="Snacks"> Snacks
        </label>
      </div>
    </div>

    <!-- Custom Food Entry -->
    <div class="mb-8 card">
      <h2 class="text-xl font-semibold mb-3">Didn't find food below? Add Custom Food</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block mb-1 text-sm font-medium">Food Name</label>
          <input type="text" id="customFoodName" placeholder="Enter food name" 
                 class="w-full p-2 border border-gray-300 rounded" aria-label="Food name"/>
        </div>
        <div>
          <label class="block mb-1 text-sm font-medium">Amount (grams)</label>
          <input type="number" id="customFoodGrams" placeholder="Enter grams consumed" 
                 class="w-full p-2 border border-gray-300 rounded" aria-label="Grams consumed" min="1"/>
        </div>
        <div class="flex items-end">
          <button onclick="searchCustomFood()" class="btn-primary w-full">
            <i data-lucide="search" class="inline w-4 h-4 mr-1"></i> Search & Add
          </button>
        </div>
      </div>
      <div id="customFoodResult" class="mt-4 hidden"></div>
    </div>

    <!-- Food Categories -->
    <div class="mb-8">
      <h2 class="text-xl font-semibold mb-4">Food Categories</h2>
      <div class="card">
        <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-200">
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="Bakery" onclick="loadFoods('Bakery')">Bakery</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="Vegetables" onclick="loadFoods('Vegetables')">Vegetables</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="Fruits" onclick="loadFoods('Fruits')">Fruits</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="Drinks" onclick="loadFoods('Drinks')">Drinks</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="Nuts" onclick="loadFoods('Nuts')">Nuts</button>
        </div>
        <div class="relative">
          <button id="prevFood" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-cal-blue text-white p-2 rounded-full shadow-md hover:bg-cal-blue-dark z-10 hidden carousel-nav">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
          </button>
          <div id="foodCarousel" class="flex overflow-x-auto snap-x snap-mandatory scroll-smooth gap-4 p-4 hide-scrollbar"></div>
          <button id="nextFood" class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-cal-blue text-white p-2 rounded-full shadow-md hover:bg-cal-blue-dark z-10 hidden carousel-nav">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Back to top button -->
    <button id="backToTopBtn" title="Go to top" aria-label="Back to top">
      <i data-lucide="arrow-up" class="w-full h-full"></i>
    </button>

    <!-- Exercise Tracker -->
    <div class="mb-8">
      <h1 class="text-3xl font-bold mb-6">Exercise Tracker</h1>
      <div class="card">
        <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-200">
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="daily" onclick="loadExercises('daily')">Daily Activities</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="heavy" onclick="loadExercises('heavy')">Heavy Activity</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="gym" onclick="loadExercises('gym')">Gym</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="light" onclick="loadExercises('light')">Light Outdoor</button>
          <button class="tab px-4 py-2 text-sm font-semibold text-gray-600 hover:text-cal-blue transition-colors" 
                  data-category="yoga" onclick="loadExercises('yoga')">Yoga</button>
        </div>
        <div class="relative">
          <button id="prevExercise" class="absolute left-0 top-1/2 transform -translate-y-1/2 bg-cal-blue text-white p-2 rounded-full shadow-md hover:bg-cal-blue-dark z-10 hidden carousel-nav">
            <i data-lucide="chevron-left" class="w-5 h-5"></i>
          </button>
          <div id="exerciseCarousel" class="flex overflow-x-auto snap-x snap-mandatory scroll-smooth gap-4 p-4 hide-scrollbar"></div>
          <button id="nextExercise" class="absolute right-0 top-1/2 transform -translate-y-1/2 bg-cal-blue text-white p-2 rounded-full shadow-md hover:bg-cal-blue-dark z-10 hidden carousel-nav">
            <i data-lucide="chevron-right" class="w-5 h-5"></i>
          </button>
        </div>
      </div>
    </div>

    <!-- Log -->
    <div class="mt-0 mb-16 card">
      <h2 class="text-xl font-semibold mb-2">Logged Items</h2>
      <ul id="logList" class="list-disc pl-6 space-y-1"></ul>
      <button onclick="submitLog()" class="mt-4 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">
        Submit Log
      </button>
    </div>
  </div>

  <script>
    // Core data structures
    let logItems = [];
    let totalFoodCalories = 0;
    let totalExerciseCalories = 0;
    let netCalories = 0;
    const userWeight = 70; // Assume extracted from profile in kg

    // Food database with icons
    const foods = {
      Bakery: [
        { name: 'Bread', kcalPer100g: 265, icon: 'bread' },
        { name: 'Muffin', kcalPer100g: 340, icon: 'bread' }
      ],
      Vegetables: [
        { name: 'Carrot', kcalPer100g: 41, icon: 'carrot' },
        { name: 'Spinach', kcalPer100g: 23, icon: 'carrot' }
      ],
      Fruits: [
        { name: 'Apple', kcalPer100g: 52, icon: 'apple' },
        { name: 'Banana', kcalPer100g: 89, icon: 'apple' }
      ],
      Drinks: [
        { name: 'Orange Juice', kcalPer100g: 45, icon: 'coffee' },
        { name: 'Milk', kcalPer100g: 42, icon: 'coffee' }
      ],
      Nuts: [
        { name: 'Almonds', kcalPer100g: 579, icon: 'nut' },
        { name: 'Cashews', kcalPer100g: 553, icon: 'nut' }
      ]
    };

    // Simulated food database for custom searches
    const foodDatabase = {
      "apple pie": { calories: 237, icon: "utensils" },
      "chicken breast": { calories: 165, icon: "utensils" },
      "rice": { calories: 130, icon: "utensils" },
      "pasta": { calories: 131, icon: "utensils" },
      "salad": { calories: 33, icon: "utensils" },
      "pizza": { calories: 266, icon: "utensils" },
      "burger": { calories: 295, icon: "utensils" },
      "chocolate": { calories: 546, icon: "utensils" },
      "cookie": { calories: 353, icon: "utensils" },
      "sandwich": { calories: 289, icon: "utensils" }
    };

    // Exercise database with icons
    const exercises = {
      daily: [
        { name: "Walking (2 mph)", met: 2.5, icon: "footprints" },
        { name: "Walking (3 mph)", met: 3.3, icon: "footprints" },
        { name: "Housework (light)", met: 2.5, icon: "brush" },
        { name: "Gardening (active)", met: 4.0, icon: "sprout" },
        { name: "Cycling (leisurely)", met: 3.5, icon: "bike" }
      ],
      heavy: [
        { name: "Running", met: 11.5, icon: "run" },
        { name: "Swimming", met: 10, icon: "waves" },
        { name: "Basketball", met: 8.0, icon: "target" }
      ],
      gym: [
        { name: "Weight Lifting", met: 6, icon: "dumbbell" },
        { name: "Treadmill", met: 8, icon: "run" }
      ],
      light: [
        { name: "Walking", met: 3.5, icon: "footprints" },
        { name: "Cycling", met: 6, icon: "bike" }
      ],
      yoga: [
        { name: "Yoga", met: 2.5, icon: "yoga" }
      ]
    };

    // Initialize the UI when the page loads
    window.onload = () => {
      renderFoodCategories();
      loadExercises('daily'); // Load default category
      lucide.createIcons();
      const backToTopBtn = document.getElementById("backToTopBtn");
      window.addEventListener("scroll", function() {
        if (window.pageYOffset > 300) {
          backToTopBtn.style.display = "block";
        } else {
          backToTopBtn.style.display = "none";
        }
      });
      backToTopBtn.addEventListener("click", function() {
        window.scrollTo({
          top: 0,
          behavior: "smooth"
        });
      });
    };

    // Validate number input
    function validateNumberInput(value, min = 0, max = 10000) {
      const num = parseFloat(value);
      return !isNaN(num) && num >= min && num <= max;
    }

    // Search for custom food
    function searchCustomFood() {
      const foodName = document.getElementById("customFoodName").value.toLowerCase().trim();
      const grams = parseFloat(document.getElementById("customFoodGrams").value);
      const resultDiv = document.getElementById("customFoodResult");
      
      if (!foodName || !validateNumberInput(grams, 1)) {
        alert("Please enter both a food name and valid amount in grams (minimum 1g)");
        return;
      }
      
      const meal = document.querySelector('input[name="meal_type"]:checked')?.value;
      if (!meal) {
        alert("Please select a meal type.");
        return;
      }

      resultDiv.innerHTML = `
        <div class="text-center py-4">
          <i data-lucide="loader" class="animate-spin mx-auto mb-2"></i>
          <p>Searching for "${foodName}"...</p>
        </div>
      `;
      resultDiv.classList.remove("hidden");
      lucide.createIcons();
      
      setTimeout(() => {
        let found = false;
        if (foodDatabase[foodName]) {
          found = foodName;
        } else {
          for (const key of Object.keys(foodDatabase)) {
            if (key.includes(foodName) || foodName.includes(key)) {
              found = key;
              break;
            }
          }
        }
        
        if (found) {
          const item = foodDatabase[found];
          const caloriesPerGram = item.calories / 100;
          const totalCalories = Math.round(caloriesPerGram * grams);
          
          resultDiv.innerHTML = `
            <div class="bg-green-50 border border-green-200 rounded p-4">
              <div class="flex items-center">
                <div class="icon-sticker mr-4">
                  <i data-lucide="${item.icon}" class="w-6 h-6 text-cal-blue"></i>
                </div>
                <div>
                  <h3 class="font-semibold text-lg capitalize">${found}</h3>
                  <p>${item.calories} kcal per 100g</p>
                  <p class="text-green-700 font-medium">${grams}g = ${totalCalories} kcal</p>
                  <button onclick="addCustomFoodToLog('${found}', ${totalCalories})" class="mt-2 btn-primary text-sm">
                    Add to Log
                  </button>
                </div>
              </div>
            </div>
          `;
        } else {
          resultDiv.innerHTML = `
            <div class="bg-yellow-50 border border-yellow-200 rounded p-4">
              <p class="mb-2">No exact match found for "${foodName}". Estimating calories...</p>
              <p>Estimated: <span class="font-semibold">85 kcal per 100g</span></p>
              <p class="text-green-700 font-medium">${grams}g = ${Math.round(85 * grams / 100)} kcal</p>
              <button onclick="addCustomFoodToLog('${foodName}', ${Math.round(85 * grams / 100)})" class="mt-2 btn-primary text-sm">
                Add to Log with Estimate
              </button>
            </div>
          `;
        }
        lucide.createIcons();
      }, 1500);
    }

    // Add custom food to log
    function addCustomFoodToLog(name, calories) {
      console.log("addCustomFoodToLog called for:", name, calories);
      const meal = document.querySelector('input[name="meal_type"]:checked')?.value;
      if (!meal) {
        console.warn("No meal type selected");
        alert("Please select a meal type.");
        return;
      }

      try {
        logItems.push({ type: 'food', name, calories, meal });
        totalFoodCalories += calories;
        updateNetCalories();
        updateLog();

        const customFoodName = document.getElementById("customFoodName");
        const customFoodGrams = document.getElementById("customFoodGrams");
        const customFoodResult = document.getElementById("customFoodResult");
        if (!customFoodName || !customFoodGrams || !customFoodResult) {
          console.error("Custom food input elements not found");
          return;
        }

        customFoodName.value = "";
        customFoodGrams.value = "";
        customFoodResult.classList.add("hidden");

        customFoodResult.innerHTML = `
          <div class="bg-green-50 border border-green-200 rounded p-4 text-green-800">
            Added ${name} (${calories} kcal) to your ${meal} log!
          </div>
        `;
        customFoodResult.classList.remove("hidden");

        setTimeout(() => {
          customFoodResult.classList.add("hidden");
        }, 3000);
      } catch (error) {
        console.error("Error in addCustomFoodToLog:", error);
      }
    }

    // Render food categories tabs
    function renderFoodCategories() {
      loadFoods('Bakery'); // Load default category
    }

    // Load foods for selected category
    function loadFoods(category) {
      try {
        console.log("loadFoods called for:", category);
        const tabs = document.querySelectorAll(".tab[data-category]");
        tabs.forEach(tab => {
          tab.classList.toggle("active", tab.dataset.category === category);
        });

        const carousel = document.getElementById("foodCarousel");
        const prevBtn = document.getElementById("prevFood");
        const nextBtn = document.getElementById("nextFood");
        carousel.innerHTML = "";

        if (!category || !foods[category]) {
          prevBtn.classList.add("hidden");
          nextBtn.classList.add("hidden");
          return;
        }

        foods[category].forEach(item => {
          const div = document.createElement("div");
          div.className = "carousel-item food-item bg-white rounded-lg shadow-sm p-4";
          div.innerHTML = `
            <div class="flex items-center mb-3">
              <div class="icon-sticker mr-3">
                <i data-lucide="${item.icon}" class="w-6 h-6 text-cal-blue"></i>
              </div>
              <h3 class="font-semibold">${item.name}</h3>
            </div>
            <p class="text-sm text-gray-600 mb-2">${item.kcalPer100g} kcal/100g</p>
            <input type="number" id="food-${btoa(item.name).slice(0, 10)}Grams" 
                   placeholder="Grams" class="w-full p-2 border rounded mb-1 text-sm" min="1"
                   aria-label="Grams of ${item.name}"/>
            <span class="text-gray-500 text-sm block text-center mb-1">or</span>
            <input type="number" id="food-${btoa(item.name).slice(0, 10)}Calories" 
                   placeholder="Calories" class="w-full p-2 border rounded mb-3 text-sm" min="1"
                   aria-label="Calories of ${item.name}"/>
            <button onclick="logFood('${item.name}', ${item.kcalPer100g})" 
                    class="btn-primary w-full text-sm transition-transform hover:scale-105"
                    aria-label="Add ${item.name} to log">
              <i data-lucide="plus" class="w-4 h-4 mr-1"></i> Add
            </button>
          `;
          carousel.appendChild(div);
        });

        prevBtn.classList.toggle("hidden", foods[category].length <= 1);
        nextBtn.classList.toggle("hidden", foods[category].length <= 1);

        prevBtn.onclick = () => carousel.scrollBy({ left: -280, behavior: "smooth" });
        nextBtn.onclick = () => carousel.scrollBy({ left: 280, behavior: "smooth" });

        lucide.createIcons();
      } catch (error) {
        console.error("Error in loadFoods:", error);
      }
    }

    // Log a food item to the daily log
    function logFood(name, kcalPer100g) {
      console.log("logFood called for:", name, kcalPer100g);
      const meal = document.querySelector('input[name="meal_type"]:checked')?.value;
      if (!meal) {
        console.warn("No meal type selected");
        alert("Please select a meal type before adding food.");
        return;
      }

      try {
        const gramsInput = document.getElementById(`food-${btoa(name).slice(0, 10)}Grams`);
        const caloriesInput = document.getElementById(`food-${btoa(name).slice(0, 10)}Calories`);
        if (!gramsInput || !caloriesInput) {
          console.error("Input elements not found for:", name);
          return;
        }

        const grams = parseFloat(gramsInput.value);
        const caloriesInputValue = parseFloat(caloriesInput.value);
        let calories;

        if (validateNumberInput(grams, 1)) {
          calories = (grams / 100) * kcalPer100g;
        } else if (validateNumberInput(caloriesInputValue, 1)) {
          calories = caloriesInputValue;
        } else {
          console.warn("Invalid input for grams or calories");
          alert("Please enter either grams (minimum 1g) or calories (minimum 1 kcal).");
          return;
        }

        console.log("Adding to logItems:", { type: 'food', name, calories: Math.round(calories), meal });
        logItems.push({ type: 'food', name, calories: Math.round(calories), meal });
        totalFoodCalories += Math.round(calories);
        updateNetCalories();
        updateLog();

        gramsInput.value = "";
        caloriesInput.value = "";
      } catch (error) {
        console.error("Error in logFood:", error);
      }
    }

    // Update dashboard and log
    function updateNetCalories() {
      try {
        netCalories = totalFoodCalories - totalExerciseCalories;
        console.log("Net calories updated:", { totalFoodCalories, totalExerciseCalories, netCalories });
      } catch (error) {
        console.error("Error in updateNetCalories:", error);
      }
    }

    // Update the log display
    function updateLog() {
      try {
        console.log("updateLog called, logItems:", logItems);
        const list = document.getElementById("logList");
        if (!list) {
          console.error("logList element not found");
          return;
        }
        list.innerHTML = "";
        logItems.forEach(item => {
          const li = document.createElement("li");
          if (item.type === 'food') {
            li.textContent = `${item.name} - ${item.calories} kcal (${item.meal})`;
            li.classList.add("text-blue-600");
          } else if (item.type === 'exercise') {
            li.textContent = `${item.name} - ${item.calories} kcal burned`;
            li.classList.add("text-red-500");
          }
          list.appendChild(li);
        });
      } catch (error) {
        console.error("Error in updateLog:", error);
      }
    }

    // Load exercises based on selected category
    function loadExercises(category) {
      try {
        console.log("loadExercises called for:", category);
        const tabs = document.querySelectorAll(".tab[data-category]");
        tabs.forEach(tab => {
          tab.classList.toggle("active", tab.dataset.category === category);
        });

        const carousel = document.getElementById("exerciseCarousel");
        const prevBtn = document.getElementById("prevExercise");
        const nextBtn = document.getElementById("nextExercise");
        carousel.innerHTML = "";

        if (!category || !exercises[category]) {
          prevBtn.classList.add("hidden");
          nextBtn.classList.add("hidden");
          return;
        }

        exercises[category].forEach(ex => {
          const div = document.createElement("div");
          div.className = "carousel-item exercise-item bg-white rounded-lg shadow-sm p-4";
          div.innerHTML = `
            <div class="flex items-center mb-3">
              <div class="icon-sticker mr-3">
                <i data-lucide="${ex.icon}" class="w-6 h-6 text-red-500"></i>
              </div>
              <h3 class="font-semibold">${ex.name}</h3>
            </div>
            <p class="text-sm text-gray-600 mb-2">Est. ${Math.round((ex.met * 3.5 * userWeight / 200) * 30)} kcal/30min</p>
            <input type="number" id="${ex.name.replace(/[^a-zA-Z0-9]/g, '')}Time" 
                   placeholder="Time (min)" class="w-full p-2 border rounded mb-1 text-sm" min="1"
                   aria-label="Time in minutes for ${ex.name}"/>
            <input type="number" id="${ex.name.replace(/[^a-zA-Z0-9]/g, '')}Calories" 
                   placeholder="Calories burnt" class="w-full p-2 border rounded mb-3 text-sm" min="1"
                   aria-label="Calories burned for ${ex.name}"/>
            <button onclick="logBurnt('${ex.name}', ${ex.met})" 
                    class="btn-burn w-full text-sm transition-transform hover:scale-105"
                    aria-label="Log ${ex.name} exercise">
              <i data-lucide="flame" class="w-4 h-4 mr-1"></i> Log Burn
            </button>
          `;
          carousel.appendChild(div);
        });

        prevBtn.classList.toggle("hidden", exercises[category].length <= 1);
        nextBtn.classList.toggle("hidden", exercises[category].length <= 1);

        prevBtn.onclick = () => carousel.scrollBy({ left: -280, behavior: "smooth" });
        nextBtn.onclick = () => carousel.scrollBy({ left: 280, behavior: "smooth" });

        lucide.createIcons();
      } catch (error) {
        console.error("Error in loadExercises:", error);
      }
    }

    // Log burnt calories
    function logBurnt(exercise, met) {
      console.log("logBurnt called for:", exercise, met);
      try {
        const timeInput = document.getElementById(`${exercise.replace(/[^a-zA-Z0-9]/g, '')}Time`);
        const caloriesInput = document.getElementById(`${exercise.replace(/[^a-zA-Z0-9]/g, '')}Calories`);

        if (!timeInput || !caloriesInput) {
          console.error("Exercise input elements not found for:", exercise);
          return;
        }

        const time = parseFloat(timeInput.value);
        const caloriesEntered = parseFloat(caloriesInput.value);

        let burntCalories = 0;

        if (validateNumberInput(caloriesEntered, 1)) {
          burntCalories = caloriesEntered;
        } else if (validateNumberInput(time, 1)) {
          burntCalories = (met * 3.5 * userWeight / 200) * time;
        } else {
          console.warn("Invalid input for time or calories");
          alert('Please enter either time (minimum 1 minute) or calories (minimum 1 kcal).');
          return;
        }

        console.log("Adding to logItems:", { type: 'exercise', name: exercise, calories: Math.round(burntCalories) });
        logItems.push({ type: 'exercise', name: exercise, calories: Math.round(burntCalories) });
        totalExerciseCalories += Math.round(burntCalories);
        updateNetCalories();
        updateLog();

        timeInput.value = "";
        caloriesInput.value = "";
      } catch (error) {
        console.error("Error in logBurnt:", error);
      }
    }

    // Submit the log
    function submitLog() {
      try {
        console.log("submitLog called, logItems:", logItems);
        if (logItems.length > 0) {
          alert("Your log has been submitted!");
          logItems = [];
          totalFoodCalories = 0;
          totalExerciseCalories = 0;
          netCalories = 0;
          updateLog();
          updateNetCalories();
        } else {
          alert("Please log some items before submitting.");
        }
      } catch (error) {
        console.error("Error in submitLog:", error);
      }
    }
  </script>
</body>
</html>